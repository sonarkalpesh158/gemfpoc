version: '3.8'
services:
  # --- 1. GemFire (Bound Address & IPv4) ---
  gemfire:
    image: apachegeode/geode:latest
    container_name: gemfire-poc
    hostname: gemfire
    ports:
      - "10334:10334"
      - "40404:40404"

    # Added a volume to store data permanently
    volumes:
      - gemfire-data:/data

    command: >
      sh -c "
        # Deletes stale lock files so it doesn't crash on restart
        rm -f locator1/vf.gf.locator.pid &&
        rm -f /data/server1/vf.gf.server.pid &&
      
        echo 'Starting Locator...' &&
        gfsh start locator --name=locator1 --port=10334 --mcast-port=0 --hostname-for-clients=gemfire --bind-address=gemfire --J=-Djava.net.preferIPv4Stack=true &&
      
        echo 'Starting Server...' &&
        # ### CHANGED: Added '--dir=/data/server1' so server files are saved in the volume we mounted
        gfsh start server --name=server1 --dir=/data/server1 --locators=gemfire[10334] --bind-address=gemfire --hostname-for-clients=gemfire --J=-Djava.net.preferIPv4Stack=true &&
      
        echo 'Creating Region...' &&
        # ### CHANGED: 
        # 1. Used '--type=PARTITION_PERSISTENT' to enable disk storage.
        # 2. Added '--if-not-exists' so it doesn't crash if the region was recovered from disk.
        gfsh -e 'connect --locator=gemfire[10334]' -e 'create region --name=Products --type=PARTITION_PERSISTENT --if-not-exists --eviction-entry-count=1000 --eviction-action=local-destroy' &&
      
        tail -f /dev/null
      "
    healthcheck:
      test: ["CMD-SHELL", "gfsh -e 'connect --locator=gemfire[10334]' -e 'list members'"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # --- 2. MySQL ---
  mysql:
    image: mysql:8.0
    container_name: mysql-poc
    hostname: mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: poc_db
    ports:
      - "3306:3306"

  # --- 3. YOUR APP ---
  app-service:
    build: .
    container_name: spring-app-poc
    ports:
      - "9090:8080"
    depends_on:
      gemfire:
        condition: service_healthy
      mysql:
        condition: service_started
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/poc_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      SPRING_DATA_GEMFIRE_POOL_LOCATORS: "gemfire[10334]"

# Defined the named volume here - docker will internally create the storage mapping with this volume for all services
volumes:
  gemfire-data: